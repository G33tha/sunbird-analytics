angular.module("sunburst.directives").directive("sunburst",["$rootScope","wordFormat","clear","nodeService","mouseevents",function(b,d,a,e,c){return{restrict:"A",scope:{data:"="},link:function(g){var h;g.$watch("data",function(i){if(i){return f(i)}else{return}},false);function f(D){var t=140;var k=100;var A=$("#sunburst").width();var v=A;var o=Math.min(A,v)/2;var s=d3.scale.linear().range([0,2*Math.PI]);var r=d3.scale.pow().exponent(0.4).range([0,o]);var B=D[0];var C=D[1];h=B;var u=d3.select("#sunburst").append("svg:svg").attr("class","sunburst-svg").attr("width",A).attr("height",v).append("svg:g").attr("id","container").attr("transform","translate("+A/2+","+v/2+")");var p=d3.layout.partition().value(function(x){return 1});var q=d3.svg.arc().startAngle(function(x){return Math.max(0,Math.min(2*Math.PI,s(x.x)))}).endAngle(function(x){return Math.max(0,Math.min(2*Math.PI,s(x.x+x.dx)))}).innerRadius(function(x){return Math.max(0,r(x.y))}).outerRadius(function(x){return Math.max(0,r(x.y+x.dy))});u.append("svg:circle").attr("r",o).style("opacity",0);var j=e.getAncestors(B);var w=u.data([B]).selectAll("#sunburst-path").data(p.nodes(B)).enter().append("svg:path").attr("id","sunburst-path").style("z-index",1).attr("d",q).attr("fill-rule","evenodd").style("fill",function(x){return x.color}).style("opacity",function(x){return x===h?0.3:1}).on("mouseover",E).on("click",m);u.append("foreignObject").attr("class","explanation-obj").attr("width","175").attr("height","50").style("z-index",100).style("cursor","pointer").attr("transform",function(x){return"translate(-90,-20)"}).append("xhtml:div").attr("id","words").attr("class","wordsDiv").on("click",z);i(h);d3.select("#container").on("mouseleave",n);function m(F){var x;if(F===h&&F.parent){h=F.parent;x=h}else{h=F;x=F}i(x);var y=e.getAncestors(x);d3.selectAll("#sunburst-path").style("opacity",function(G){return y.indexOf(G)!==-1||G===h?0.15:1});w.transition().duration(500).attrTween("d",l(x))}function z(){var x;if(h&&h.parent){h=h.parent;x=h}i(x);var y=e.getAncestors(x);d3.selectAll("#sunburst-path").style("opacity",function(F){return y.indexOf(F)!==-1||F===h?0.15:1});w.transition().duration(500).attrTween("d",l(x))}function l(G){var y=d3.interpolate(s.domain(),[G.x,G.x+G.dx]),F=d3.interpolate(r.domain(),[G.y,1]),x=d3.interpolate(r.range(),[G.y?20:0,o]);return function(I,H){return H?function(J){return q(I)}:function(J){s.domain(y(J));r.domain(F(J)).range(x(J));return q(I)}}}function i(F){d3.select("#words").empty();var x=[F.name];if(F.depth==0){$("#sunburstConceptCount").html((F.sum+1)+"<span>&nbsp;Concepts</span>");$("#sunburstContentCount").html(C.totalCount+"<span>&nbsp;Videos & Documents</span>")}else{$("#sunburstConceptCount").html((F.sum+1)+"<span>&nbsp;Concepts</span>");$("#sunburstContentCount").html((F.contentCount?F.contentCount:0)+"<span>&nbsp;Videos & Documents</span>")}var y=d.formatWords(x,"sunburst");d3.select("#words").html(y);d3.select("#words").style("visibility","")}function E(y){i(y);d3.selectAll("#sunburst-path").style("opacity",0.6);var x=e.getAncestorsWithoutRoot(y);u.selectAll("#sunburst-path").style("opacity",function(F){if(F.depth==0){return 0}return x.indexOf(F)>x.indexOf(h)?1:0.6})}function n(){d3.selectAll("#sunburst-path").on("mouseover",null);var x=e.getAncestors(h);d3.selectAll("#sunburst-path").transition().duration(1000).style("opacity",function(y){if(!y.children){return 0.4}else{return x.indexOf(y)!==-1?0.15:1}}).each("end",function(){d3.select(this).on("mouseover",E)});i(h)}$("path").popover({container:"body",trigger:"hover",html:true,placement:"right"})}}}}]);